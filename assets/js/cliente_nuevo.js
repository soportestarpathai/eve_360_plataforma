/**
 * Cliente Nuevo Page JavaScript
 * Handles client creation wizard, PLD validation, and form submission
 */

// Global Variables
let catalogs = {};
let personaTypes = [];
let apoderadoCounter = 0;
let currentStep = 1;
let isValidatedPLD = false; // Flag to control submission
let currentSearchId = null;
let isAutoGeneratedContract = false;
const pldSearchCache = new Map();
let lastPldSignature = '';
const RFC_FISICA_REGEX = /^[A-ZÑ&]{4}\d{6}[A-Z0-9]{3}$/;
const RFC_MORAL_REGEX = /^[A-ZÑ&]{3}\d{6}[A-Z0-9]{3}$/;
const CURP_REGEX = /^[A-Z][AEIOUX][A-Z]{2}\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])[HM](AS|BC|BS|CC|CL|CM|CS|CH|DF|DG|GT|GR|HG|JC|MC|MN|MS|NT|NL|OC|PL|QT|QR|SP|SL|SR|TC|TS|TL|VZ|YN|ZS|NE)[B-DF-HJ-NP-TV-Z]{3}[A-Z0-9]\d$/;
let dynamicRowCounter = 0;

const ADDRESS_TYPE_OPTIONS = [
    { id: 1, label: 'Casa / Particular' },
    { id: 2, label: 'Oficina' },
    { id: 3, label: 'Domicilio Fiscal' },
    { id: 4, label: 'Sucursal' },
    { id: 5, label: 'Otro' }
];

const MEXICO_STATES_FALLBACK = [
    'Aguascalientes', 'Baja California', 'Baja California Sur', 'Campeche', 'Chiapas', 'Chihuahua',
    'Ciudad de Mexico', 'Coahuila', 'Colima', 'Durango', 'Guanajuato', 'Guerrero', 'Hidalgo', 'Jalisco',
    'Mexico', 'Michoacan', 'Morelos', 'Nayarit', 'Nuevo Leon', 'Oaxaca', 'Puebla', 'Queretaro',
    'Quintana Roo', 'San Luis Potosi', 'Sinaloa', 'Sonora', 'Tabasco', 'Tamaulipas', 'Tlaxcala',
    'Veracruz', 'Yucatan', 'Zacatecas'
];

const MEXICO_MUNICIPALITIES_FALLBACK = {
    Aguascalientes: ['Aguascalientes', 'Jesus Maria'],
    'Baja California': ['Tijuana', 'Mexicali'],
    'Baja California Sur': ['La Paz', 'Los Cabos'],
    Campeche: ['Campeche', 'Carmen'],
    Chiapas: ['Tuxtla Gutierrez', 'Tapachula'],
    Chihuahua: ['Chihuahua', 'Juarez'],
    'Ciudad de Mexico': ['Alvaro Obregon', 'Benito Juarez', 'Cuauhtemoc', 'Iztapalapa', 'Miguel Hidalgo'],
    Coahuila: ['Saltillo', 'Torreon'],
    Colima: ['Colima', 'Manzanillo'],
    Durango: ['Durango', 'Gomez Palacio'],
    Guanajuato: ['Leon', 'Irapuato'],
    Guerrero: ['Acapulco', 'Chilpancingo'],
    Hidalgo: ['Pachuca', 'Tulancingo'],
    Jalisco: ['Guadalajara', 'Zapopan'],
    Mexico: ['Toluca', 'Ecatepec', 'Naucalpan'],
    Michoacan: ['Morelia', 'Uruapan'],
    Morelos: ['Cuernavaca', 'Jiutepec'],
    Nayarit: ['Tepic', 'Bahia de Banderas'],
    'Nuevo Leon': ['Monterrey', 'San Nicolas de los Garza'],
    Oaxaca: ['Oaxaca de Juarez', 'Salina Cruz'],
    Puebla: ['Puebla', 'Tehuacan'],
    Queretaro: ['Queretaro', 'San Juan del Rio'],
    'Quintana Roo': ['Benito Juarez', 'Solidaridad'],
    'San Luis Potosi': ['San Luis Potosi', 'Soledad de Graciano Sanchez'],
    Sinaloa: ['Culiacan', 'Mazatlan'],
    Sonora: ['Hermosillo', 'Cajeme'],
    Tabasco: ['Centro', 'Comalcalco'],
    Tamaulipas: ['Reynosa', 'Matamoros'],
    Tlaxcala: ['Tlaxcala', 'Apizaco'],
    Veracruz: ['Xalapa', 'Veracruz'],
    Yucatan: ['Merida', 'Valladolid'],
    Zacatecas: ['Zacatecas', 'Fresnillo']
};

const sepomexCache = {
    statesReady: false,
    states: [],
    municipalitiesByState: new Map(),
    postalCodesByStateMunicipality: new Map(),
    cpLookup: new Map()
};

// --- 1. VALIDATION LOGIC ---
function normalizePldValue(value) {
    return (value || '')
        .toString()
        .trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g, ' ');
}

function resetPldValidationState() {
    isValidatedPLD = false;
    currentSearchId = null;
    const statusSpan = document.getElementById('validationStatus');
    if (statusSpan) {
        statusSpan.innerHTML = 'Pendiente de validación';
        statusSpan.className = 'text-muted';
    }
}

function getPldSearchPayload(isAutomatic = false) {
    const personaFisica = document.getElementById('persona-fisica');
    const personaMoral = document.getElementById('persona-moral');
    if (!personaFisica || !personaMoral) {
        return { ok: false, message: 'No se pudo identificar el tipo de persona.' };
    }

    const isFisica = personaFisica.style.display !== 'none';
    const isMoral = personaMoral.style.display !== 'none';
    const data = {
        nombre: '',
        paterno: '',
        materno: '',
        tipo_persona: '',
        save_history: true,
        use_cache: true
    };

    if (isFisica) {
        data.nombre = document.getElementById('fisica_nombre')?.value.trim() || '';
        data.paterno = document.getElementById('fisica_ap_paterno')?.value.trim() || '';
        data.materno = document.getElementById('fisica_ap_materno')?.value.trim() || '';
        data.tipo_persona = 'fisica';
        if (!data.nombre || !data.paterno) {
            return {
                ok: false,
                message: isAutomatic
                    ? 'Datos insuficientes para validar en listas.'
                    : 'Por favor complete al menos Nombre y Apellido Paterno para realizar la búsqueda.'
            };
        }
    } else if (isMoral) {
        data.nombre = document.getElementById('moral_razon_social')?.value.trim() || '';
        data.tipo_persona = 'moral';
        if (data.nombre.length < 3) {
            return {
                ok: false,
                message: isAutomatic
                    ? 'Datos insuficientes para validar en listas.'
                    : 'Por favor ingrese la Razón Social (mínimo 3 caracteres) para realizar la búsqueda.'
            };
        }
    } else {
        return { ok: false, message: 'Por favor seleccione el tipo de persona primero.' };
    }

    return { ok: true, data };
}

function getPldSearchSignature(data) {
    return [
        data.tipo_persona,
        normalizePldValue(data.nombre),
        normalizePldValue(data.paterno),
        normalizePldValue(data.materno)
    ].join('|');
}

function showPldModalLoading() {
    const modalEl = document.getElementById('pldModal');
    if (!modalEl) return;
    const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
    modal.show();

    const pldLoading = document.getElementById('pldLoading');
    const pldResults = document.getElementById('pldResults');
    const pldClean = document.getElementById('pldClean');
    const btnConfirmPld = document.getElementById('btnConfirmPld');
    const btnCloseClean = document.getElementById('btnCloseClean');
    const fileInput = document.getElementById('pldSupportFile');

    if (pldLoading) {
        pldLoading.innerHTML = `
            <i class="fa-solid fa-spinner fa-spin fa-3x"></i>
            <p class="mt-3">Consultando listas...</p>
        `;
        pldLoading.style.display = 'block';
    }
    if (pldResults) pldResults.style.display = 'none';
    if (pldClean) pldClean.style.display = 'none';
    if (btnConfirmPld) btnConfirmPld.style.display = 'none';
    if (btnCloseClean) btnCloseClean.style.display = 'none';
    if (fileInput) fileInput.value = '';
}

function renderPldResult(result, isAutomatic = false) {
    const statusSpan = document.getElementById('validationStatus');
    if (!statusSpan) return;

    if (result.id_busqueda) {
        currentSearchId = result.id_busqueda;
    }

    if (result.found) {
        statusSpan.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> COINCIDENCIA EN LISTAS (Requiere Acción)';
        statusSpan.className = 'text-risk';
        isValidatedPLD = false;

        if (!isAutomatic) {
            const pldLoading = document.getElementById('pldLoading');
            const pldResults = document.getElementById('pldResults');
            const btnConfirmPld = document.getElementById('btnConfirmPld');

            if (pldLoading) pldLoading.style.display = 'none';
            if (pldResults) pldResults.style.display = 'block';
            if (btnConfirmPld) btnConfirmPld.style.display = 'block';
            renderHits(Array.isArray(result.data) ? result.data : []);
        }
    } else {
        statusSpan.innerHTML = '<i class="fa-solid fa-check-circle"></i> Sin coincidencias (Limpio)';
        statusSpan.className = 'text-ok';
        isValidatedPLD = true;

        if (!isAutomatic) {
            const pldLoading = document.getElementById('pldLoading');
            const pldClean = document.getElementById('pldClean');
            const btnCloseClean = document.getElementById('btnCloseClean');

            if (pldLoading) pldLoading.style.display = 'none';
            if (pldClean) pldClean.style.display = 'block';
            if (btnCloseClean) btnCloseClean.style.display = 'block';
        }
    }
}

async function validatePerson(isAutomatic = false, options = {}) {
    const statusSpan = document.getElementById('validationStatus');
    if (!statusSpan) return { status: 'error', message: 'Estatus PLD no disponible' };

    const settings = {
        openModal: !isAutomatic,
        useClientCache: !isAutomatic,
        ...options
    };

    const payloadData = getPldSearchPayload(isAutomatic);
    if (!payloadData.ok) {
        if (!isAutomatic) {
            alert(payloadData.message);
        }
        return { status: 'error', message: payloadData.message };
    }

    const data = payloadData.data;
    const signature = getPldSearchSignature(data);

    if (settings.openModal) {
        showPldModalLoading();
    } else {
        statusSpan.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Consultando...';
        statusSpan.className = 'text-muted';
    }

    if (settings.useClientCache && pldSearchCache.has(signature)) {
        const cachedResult = pldSearchCache.get(signature);
        lastPldSignature = signature;
        renderPldResult(cachedResult, isAutomatic);
        return { status: 'success', found: !!cachedResult.found, cached: true };
    }

    try {
        const res = await fetch('api/validate_person.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const text = await res.text();
        let result;
        try {
            result = JSON.parse(text);
        } catch (parseErr) {
            throw new Error('Respuesta inválida del servidor: ' + text.substring(0, 100));
        }

        if (!res.ok || result.status !== 'success') {
            const errorMsg = result?.message || `HTTP ${res.status}: ${res.statusText}`;
            throw new Error(errorMsg);
        }

        pldSearchCache.set(signature, result);
        lastPldSignature = signature;
        renderPldResult(result, isAutomatic);
        return { status: 'success', found: !!result.found, cached: !!result.cached };
    } catch (err) {
        console.error('PLD Validation Error:', err);
        statusSpan.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> Error de conexión';
        statusSpan.className = 'text-risk';

        if (!isAutomatic) {
            const pldLoading = document.getElementById('pldLoading');
            if (pldLoading) {
                pldLoading.innerHTML = '<p class="text-danger"><i class="fa-solid fa-wifi me-2"></i>Error: ' + err.message + '</p>';
            }
        }
        return { status: 'error', message: err.message || 'Error en consulta PLD' };
    }
}

function renderHits(hits) {
    const container = document.getElementById('hitsContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!hits || hits.length === 0) {
        container.innerHTML = '<div class="text-center p-4 text-muted"><i class="fa-solid fa-info-circle me-2"></i>No se encontraron detalles de coincidencias.</div>';
        return;
    }
    
    hits.forEach((hit, index) => {
        const div = document.createElement('div');
        div.className = 'hit-row';
        
        // Determine badge class based on score
        const score = parseFloat(hit.porcentaje || 0);
        const badgeClass = score >= 90 ? 'bg-danger text-white' : 'bg-warning text-dark';
        const badgeText = score >= 90 ? 'ALTO RIESGO' : 'RIESGO MEDIO';
        
        // Escape HTML to prevent XSS
        const nombre = (hit.nombreCompleto || 'Nombre desconocido').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const lista = (hit.lista || 'Lista desconocida').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const entidad = (hit.entidad || 'N/A').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const puesto = (hit.puesto || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const fecha = (hit.fecha || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const estatus = (hit.estatus || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        div.innerHTML = `
            <div class="form-check">
                <input class="form-check-input" type="radio" name="pldSelection" id="hit_${index}" value='${JSON.stringify(hit).replace(/'/g, "&apos;")}'>
                <label class="form-check-label w-100" for="hit_${index}">
                    <div class="fw-bold">
                        <i class="fa-solid fa-user-xmark"></i>
                        ${nombre}
                        <span class="badge ${badgeClass} ms-2">${badgeText} ${score}%</span>
                    </div>
                    <div class="small mt-2">
                        <span><i class="fa-solid fa-list me-1"></i><strong>Lista:</strong> ${lista}</span>
                        ${entidad !== 'N/A' ? `<span><i class="fa-solid fa-building me-1"></i><strong>Entidad:</strong> ${entidad}</span>` : ''}
                        ${puesto ? `<span><i class="fa-solid fa-briefcase me-1"></i><strong>Puesto:</strong> ${puesto}</span>` : ''}
                        ${fecha ? `<span><i class="fa-solid fa-calendar me-1"></i><strong>Fecha:</strong> ${fecha}</span>` : ''}
                        ${estatus ? `<span><i class="fa-solid fa-flag me-1"></i><strong>Estatus:</strong> ${estatus}</span>` : ''}
                    </div>
                </label>
            </div>
        `;
        container.appendChild(div);
    });
}

function confirmPld() {
    const selected = document.querySelector('input[name="pldSelection"]:checked');
    if (!selected) { 
        alert("Debe seleccionar un resultado o la opción 'Ninguna'."); 
        return; 
    }
    if (!currentSearchId) {
        alert('No se encontró el folio de búsqueda. Ejecute nuevamente la validación en listas.');
        return;
    }
    
    const comments = document.getElementById('pldComments').value;
    const supportFileInput = document.getElementById('pldSupportFile');
    const supportFile = supportFileInput?.files?.[0] || null;
    if (selected.value === 'none' && comments.trim().length < 5) {
        alert("Si selecciona 'Ninguna', es obligatorio agregar un comentario.");
        return;
    }

    if (supportFile && supportFile.size > 10 * 1024 * 1024) {
        alert('El documento de soporte no puede exceder 10 MB.');
        return;
    }

    const payload = new FormData();
    payload.append('id_busqueda', currentSearchId || '');
    payload.append('seleccion', selected.value);
    payload.append('comentarios', comments);
    payload.append('riesgo_final', (selected.value === 'none') ? '0' : '1');
    if (supportFile) {
        payload.append('documento_soporte', supportFile);
    }

    const btnConfirm = document.getElementById('btnConfirmPld');
    const originalText = btnConfirm ? btnConfirm.innerHTML : '';
    if (btnConfirm) {
        btnConfirm.disabled = true;
        btnConfirm.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Guardando...';
    }

    fetch('api/confirm_pld_selection.php', { method: 'POST', body: payload })
        .then(res => res.json())
        .then(json => {
            if (json.status === 'success') {
                isValidatedPLD = true;
                const statusSpan = document.getElementById('validationStatus');
                if (statusSpan) {
                    statusSpan.innerHTML = '<i class="fa-solid fa-check-double"></i> Validación Confirmada';
                    statusSpan.className = 'text-success';
                }
                const commentsEl = document.getElementById('pldComments');
                if (commentsEl) commentsEl.value = '';
                if (supportFileInput) supportFileInput.value = '';
                bootstrap.Modal.getInstance(document.getElementById('pldModal')).hide();
            } else {
                alert('Error al guardar selección: ' + (json.message || 'Error desconocido'));
            }
        })
        .catch(err => {
            alert('No fue posible guardar la selección: ' + err.message);
        })
        .finally(() => {
            if (btnConfirm) {
                btnConfirm.disabled = false;
                btnConfirm.innerHTML = originalText;
            }
        });
}

function setContractValidationMessage(message, type = 'muted') {
    const msgEl = document.getElementById('contractValidationMessage');
    if (!msgEl) return;
    msgEl.className = 'small mt-1';
    if (type === 'ok') {
        msgEl.classList.add('text-success');
    } else if (type === 'error') {
        msgEl.classList.add('text-danger');
    } else {
        msgEl.classList.add('text-muted');
    }
    msgEl.textContent = message || '';
}

async function checkContractExists(noContrato) {
    const value = (noContrato || '').trim();
    if (!value) {
        return { exists: false };
    }

    const res = await fetch(`api/check_contract_number.php?no_contrato=${encodeURIComponent(value)}`);
    const data = await res.json();
    if (!res.ok || data.status !== 'success') {
        throw new Error(data.message || 'No se pudo validar el No. de contrato');
    }
    return data;
}

async function validateContractField(showAlert = false) {
    const input = document.getElementById('noContratoInput');
    if (!input) return true;
    const value = input.value.trim();
    const autoFlag = document.getElementById('autoGeneratedContract');

    input.value = value;
    if (value === '') {
        input.setCustomValidity('No. de contrato requerido');
        setContractValidationMessage('Captura un No. de contrato.', 'error');
        if (showAlert) {
            alert('Debe capturar el No. de contrato.');
        }
        return false;
    }

    try {
        const result = await checkContractExists(value);
        if (result.exists) {
            input.setCustomValidity('Contrato duplicado');
            setContractValidationMessage(`El contrato ${value} ya está registrado.`, 'error');
            if (showAlert) {
                alert('El No. de contrato ya está registrado. Capture otro o genere uno nuevo.');
            }
            return false;
        }
        input.setCustomValidity('');
        setContractValidationMessage('No. de contrato disponible.', 'ok');
        if (autoFlag) autoFlag.value = isAutoGeneratedContract ? '1' : '0';
        return true;
    } catch (err) {
        console.error(err);
        input.setCustomValidity('No fue posible validar');
        setContractValidationMessage('No fue posible validar el contrato en este momento.', 'error');
        if (showAlert) {
            alert('No fue posible validar el No. de contrato. Intenta de nuevo.');
        }
        return false;
    }
}

async function generateContractNumber() {
    const btn = document.getElementById('btnGenerateContract');
    const input = document.getElementById('noContratoInput');
    const autoFlag = document.getElementById('autoGeneratedContract');
    const hint = document.getElementById('contractHint');
    if (!btn || !input) return;

    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>Generando...';

    try {
        const res = await fetch('api/generate_contract_number.php', { method: 'POST' });
        const data = await res.json();
        if (!res.ok || data.status !== 'success') {
            throw new Error(data.message || 'No fue posible generar el contrato');
        }

        input.value = data.no_contrato || '';
        isAutoGeneratedContract = true;
        if (autoFlag) autoFlag.value = '1';
        if (hint && data.config) {
            const prefijo = data.config.prefijo || '';
            const modo = Number(data.config.rellenar_ceros || 0) === 1
                ? `con relleno a ${data.config.longitud || 0} dígitos`
                : 'sin relleno de ceros';
            hint.textContent = `Formato activo: ${prefijo}{secuencia} (${modo}). Siguiente: ${data.config.siguiente}`;
        }
        await validateContractField(false);
    } catch (err) {
        console.error(err);
        setContractValidationMessage(err.message || 'No se pudo generar el contrato.', 'error');
        alert(err.message || 'No se pudo generar el No. de contrato.');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

function syncFieldValue(sourceId, targetId) {
    const source = document.getElementById(sourceId);
    const target = document.getElementById(targetId);
    if (!source || !target) return;
    target.value = source.value || '';
}

function setupBidirectionalSync(leftId, rightId) {
    const left = document.getElementById(leftId);
    const right = document.getElementById(rightId);
    if (!left || !right) return;
    left.addEventListener('input', () => syncFieldValue(leftId, rightId));
    right.addEventListener('input', () => syncFieldValue(rightId, leftId));
}

function toggleGeneralPersonaFields(persona) {
    const wrapper = document.getElementById('generalPersonaFields');
    const fisica = document.getElementById('general-persona-fisica');
    const moral = document.getElementById('general-persona-moral');
    const fide = document.getElementById('general-persona-fideicomiso');
    if (!wrapper || !fisica || !moral || !fide) return;

    wrapper.style.display = persona ? 'block' : 'none';
    fisica.style.display = 'none';
    moral.style.display = 'none';
    fide.style.display = 'none';

    ['general_fisica_nombre', 'general_fisica_ap_paterno', 'general_fisica_ap_materno', 'general_moral_nombre_comercial', 'general_moral_razon_social', 'general_fide_numero']
        .forEach((id) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.required = false;
        });

    if (!persona) return;
    if (Number(persona.es_fisica) > 0) {
        fisica.style.display = 'flex';
        const nombre = document.getElementById('general_fisica_nombre');
        const paterno = document.getElementById('general_fisica_ap_paterno');
        if (nombre) nombre.required = true;
        if (paterno) paterno.required = true;
    } else if (Number(persona.es_moral) > 0) {
        moral.style.display = 'flex';
        const nombreCom = document.getElementById('general_moral_nombre_comercial');
        const razon = document.getElementById('general_moral_razon_social');
        if (nombreCom) nombreCom.required = true;
        if (razon) razon.required = true;
    } else if (Number(persona.es_fideicomiso) > 0) {
        fide.style.display = 'flex';
        const numero = document.getElementById('general_fide_numero');
        if (numero) numero.required = true;
    }
}

function validateGeneralPersonaFields(persona) {
    if (!persona) {
        alert('Seleccione el tipo de persona.');
        return false;
    }
    if (Number(persona.es_fisica) > 0) {
        const nombre = document.getElementById('general_fisica_nombre')?.value.trim() || '';
        const paterno = document.getElementById('general_fisica_ap_paterno')?.value.trim() || '';
        if (!nombre || !paterno) {
            alert('Capture Nombre(s) y Apellido Paterno en Información General.');
            return false;
        }
    } else if (Number(persona.es_moral) > 0) {
        const nombreCom = document.getElementById('general_moral_nombre_comercial')?.value.trim() || '';
        const razon = document.getElementById('general_moral_razon_social')?.value.trim() || '';
        if (!nombreCom || !razon) {
            alert('Capture Nombre Comercial y Razón Social en Información General.');
            return false;
        }
    } else if (Number(persona.es_fideicomiso) > 0) {
        const numero = document.getElementById('general_fide_numero')?.value.trim() || '';
        if (!numero) {
            alert('Capture el Número de Fideicomiso en Información General.');
            return false;
        }
    }
    return true;
}

async function validateStep1BeforeNext() {
    const tipoPersonaSelect = document.getElementById('tipoPersona');
    const persona = personaTypes.find((p) => String(p.id_tipo_persona) === String(tipoPersonaSelect?.value || ''));

    if (!persona) {
        alert('Seleccione el Tipo de Persona.');
        return false;
    }

    if (!validateGeneralPersonaFields(persona)) {
        return false;
    }

    const contractOk = await validateContractField(true);
    if (!contractOk) {
        return false;
    }

    return true;
}

function formatDateForInput(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
    const d = String(dateObj.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}

function parseInputDate(value) {
    if (!value) return null;
    const date = new Date(value + 'T00:00:00');
    if (Number.isNaN(date.getTime())) return null;
    return date;
}

function normalizeTaxInput(inputId) {
    const el = document.getElementById(inputId);
    if (!el) return '';
    el.value = (el.value || '').toUpperCase().replace(/\s+/g, '').trim();
    return el.value;
}

function invalidateField(fieldId, message) {
    const field = document.getElementById(fieldId);
    if (!field) {
        alert(message);
        return false;
    }
    field.setCustomValidity(message);
    field.reportValidity();
    field.focus();
    return false;
}

function clearStep2CustomValidity() {
    ['fisica_fecha_nacimiento', 'fisica_tax_id', 'fisica_curp', 'moral_fecha_constitucion', 'moral_tax_id']
        .forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.setCustomValidity('');
        });
}

function validateStep2IdentityFields() {
    clearStep2CustomValidity();

    const personaFisica = document.getElementById('persona-fisica');
    const personaMoral = document.getElementById('persona-moral');
    const isFisica = personaFisica && personaFisica.style.display !== 'none';
    const isMoral = personaMoral && personaMoral.style.display !== 'none';

    if (isFisica) {
        const nombre = document.getElementById('fisica_nombre')?.value.trim() || '';
        const paterno = document.getElementById('fisica_ap_paterno')?.value.trim() || '';
        if (!nombre || !paterno) {
            alert('Capture al menos Nombre y Apellido Paterno para persona física.');
            return false;
        }

        const fechaValue = document.getElementById('fisica_fecha_nacimiento')?.value || '';
        if (!fechaValue) {
            return invalidateField('fisica_fecha_nacimiento', 'La Fecha de Nacimiento es obligatoria.');
        }

        const fechaNac = parseInputDate(fechaValue);
        if (!fechaNac) {
            return invalidateField('fisica_fecha_nacimiento', 'La Fecha de Nacimiento no es válida.');
        }

        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        const fechaMinimaMayorEdad = new Date(hoy);
        fechaMinimaMayorEdad.setFullYear(fechaMinimaMayorEdad.getFullYear() - 18);
        if (fechaNac > fechaMinimaMayorEdad) {
            return invalidateField('fisica_fecha_nacimiento', 'La persona debe ser mayor de 18 años.');
        }

        const rfc = normalizeTaxInput('fisica_tax_id');
        if (!rfc) {
            return invalidateField('fisica_tax_id', 'El RFC es obligatorio.');
        }
        if (!RFC_FISICA_REGEX.test(rfc)) {
            return invalidateField('fisica_tax_id', 'RFC inválido para persona física. Formato esperado: AAAA000000AAA.');
        }

        const curp = normalizeTaxInput('fisica_curp');
        if (curp && !CURP_REGEX.test(curp)) {
            return invalidateField('fisica_curp', 'CURP inválida. Verifique estructura y fecha.');
        }
    } else if (isMoral) {
        const razonSocial = document.getElementById('moral_razon_social')?.value.trim() || '';
        if (!razonSocial || razonSocial.length < 3) {
            alert('Capture la Razón Social (mínimo 3 caracteres).');
            return false;
        }

        const fechaConst = document.getElementById('moral_fecha_constitucion')?.value || '';
        if (!fechaConst) {
            return invalidateField('moral_fecha_constitucion', 'La Fecha de Constitución es obligatoria.');
        }
        const fechaConstitucion = parseInputDate(fechaConst);
        if (!fechaConstitucion) {
            return invalidateField('moral_fecha_constitucion', 'La Fecha de Constitución no es válida.');
        }
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        if (fechaConstitucion > hoy) {
            return invalidateField('moral_fecha_constitucion', 'La Fecha de Constitución no puede ser futura.');
        }

        const rfcMoral = normalizeTaxInput('moral_tax_id');
        if (!rfcMoral) {
            return invalidateField('moral_tax_id', 'El RFC es obligatorio.');
        }
        if (!RFC_MORAL_REGEX.test(rfcMoral)) {
            return invalidateField('moral_tax_id', 'RFC inválido para persona moral. Formato esperado: AAA000000AAA.');
        }
    }

    return true;
}

async function validateStep2BeforeNext() {
    const identityValid = validateStep2IdentityFields();
    if (!identityValid) return false;

    if (isValidatedPLD) return true;

    const pldResult = await validatePerson(false, { openModal: true, useClientCache: true });
    if (pldResult.status !== 'success') return false;
    if (pldResult.found) return false;
    const modalEl = document.getElementById('pldModal');
    const modalInstance = modalEl ? bootstrap.Modal.getInstance(modalEl) : null;
    if (modalInstance) {
        modalInstance.hide();
    }
    return isValidatedPLD;
}

function validateStep3BeforeNext() {
    const nacionalidades = Array.from(document.querySelectorAll('#nacionalidades-list select[name="nacionalidad_id[]"]'));
    if (nacionalidades.length === 0) {
        alert('Debe agregar al menos una nacionalidad.');
        return false;
    }
    for (const select of nacionalidades) {
        if (!select.value) {
            select.reportValidity();
            select.focus();
            alert('Seleccione la nacionalidad en todos los registros.');
            return false;
        }
    }

    const identRows = Array.from(document.querySelectorAll('#identificaciones-list .dynamic-list-item'));
    if (identRows.length === 0) {
        alert('Debe agregar al menos una identificación.');
        return false;
    }
    for (const row of identRows) {
        const tipo = row.querySelector('select[name="ident_tipo[]"]');
        const numero = row.querySelector('input[name="ident_numero[]"]');
        if (!tipo || !tipo.value) {
            alert('Seleccione el tipo en todas las identificaciones.');
            tipo?.focus();
            return false;
        }
        if (!numero || !numero.value.trim()) {
            alert('Capture el número en todas las identificaciones.');
            numero?.focus();
            return false;
        }
    }

    const dirRows = Array.from(document.querySelectorAll('#direcciones-list .dynamic-list-item'));
    if (dirRows.length === 0) {
        alert('Debe agregar al menos una dirección.');
        return false;
    }
    for (const row of dirRows) {
        const tipo = row.querySelector('select[name="dir_tipo[]"]');
        const estado = row.querySelector('select[name="dir_estado[]"]');
        const municipio = row.querySelector('input[name="dir_municipio[]"]');
        const cp = row.querySelector('input[name="dir_cp[]"]');
        const calle = row.querySelector('input[name="dir_calle[]"]');
        const colonia = row.querySelector('input[name="dir_colonia[]"]');

        if (!tipo?.value || !estado?.value || !municipio?.value.trim() || !calle?.value.trim() || !colonia?.value.trim()) {
            alert('Complete Tipo, Estado, Municipio, Calle y Colonia en todas las direcciones.');
            return false;
        }
        const cpValue = (cp?.value || '').trim();
        if (!/^\d{5}$/.test(cpValue)) {
            alert('Cada dirección debe tener Código Postal válido de 5 dígitos.');
            cp?.focus();
            return false;
        }
    }

    return true;
}

function validateStep4BeforeSubmit() {
    const persona = getSelectedPersonaConfig();
    if (!persona) {
        alert('Seleccione el tipo de persona antes de guardar.');
        return false;
    }

    const actividad = document.getElementById('kyc_id_actividad');
    const antiguedad = document.getElementById('kyc_antiguedad_anios');
    const origen = document.getElementById('kyc_id_origen_recursos');

    if (!actividad?.value) {
        actividad?.focus();
        alert('Seleccione la actividad del cliente.');
        return false;
    }
    const antiguedadValue = Number((antiguedad?.value || '').toString().trim());
    if (!Number.isFinite(antiguedadValue) || antiguedadValue < 0 || antiguedadValue > 120) {
        antiguedad?.focus();
        alert('Capture una antigüedad válida en años (0 a 120).');
        return false;
    }
    if (!origen?.value) {
        origen?.focus();
        alert('Seleccione el origen de recursos.');
        return false;
    }

    const isFisica = Number(persona.es_fisica || 0) > 0;
    if (isFisica) {
        const empleo = document.getElementById('kyc_empleo_actual');
        const ocupacion = document.getElementById('kyc_id_ocupacion');
        const estudios = document.getElementById('kyc_nivel_estudios');
        const pep = document.getElementById('kyc_tiene_familiar_pep');

        if (!empleo?.value.trim()) {
            empleo?.focus();
            alert('Capture el empleo actual.');
            return false;
        }
        if (!ocupacion?.value) {
            ocupacion?.focus();
            alert('Seleccione la ocupación.');
            return false;
        }
        if (!estudios?.value) {
            estudios?.focus();
            alert('Seleccione el nivel de estudios.');
            return false;
        }
        if (pep?.value !== '0' && pep?.value !== '1') {
            pep?.focus();
            alert('Indique si tiene familiar directo políticamente expuesto.');
            return false;
        }

        if (pep.value === '1') {
            const parentesco = document.getElementById('kyc_parentesco_familiar_pep');
            const nombreFamiliar = document.getElementById('kyc_nombre_familiar_pep');
            const puesto = document.getElementById('kyc_puesto_familiar_pep');
            const fechaIngreso = document.getElementById('kyc_fecha_ingreso_pep');
            if (!parentesco?.value || !nombreFamiliar?.value.trim() || !puesto?.value.trim() || !fechaIngreso?.value) {
                alert('Complete parentesco, nombre, puesto y fecha de ingreso del familiar PEP.');
                parentesco?.focus();
                return false;
            }
            const fechaPep = parseInputDate(fechaIngreso.value);
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            if (!fechaPep || fechaPep > hoy) {
                fechaIngreso.focus();
                alert('La fecha de ingreso del familiar PEP no puede ser futura.');
                return false;
            }
        }
    }

    return true;
}

// --- 2. NAVIGATION FUNCTIONS ---
async function nextStep(step) {
    if (currentStep === 1 && step === 2) {
        const okStep1 = await validateStep1BeforeNext();
        if (!okStep1) return;
    }

    if (currentStep === 2 && step === 3) {
        const okStep2 = await validateStep2BeforeNext();
        if (!okStep2) return;
    }

    if (currentStep === 3 && step === 4) {
        const okStep3 = validateStep3BeforeNext();
        if (!okStep3) return;
    }
    
    document.getElementById(`step-${currentStep}`).classList.remove('active');
    document.getElementById(`step-${step}`).classList.add('active');
    currentStep = step;
    window.scrollTo(0, 0);
}

function prevStep(step) {
    document.getElementById(`step-${currentStep}`).classList.remove('active');
    document.getElementById(`step-${step}`).classList.add('active');
    currentStep = step;
    window.scrollTo(0, 0);
}

// --- 3. UTILITY FUNCTIONS ---
function populateSelect(elementId, data, valueField, labelField) {
    const select = document.getElementById(elementId);
    if (!select) return;
    
    select.innerHTML = '<option value="">-- Seleccione --</option>';
    data.forEach(item => {
        select.innerHTML += `<option value="${item[valueField]}">${item[labelField]}</option>`;
    });
}

function populateSelectFromCatalog(elementId, items, valueField, labelField, placeholder = '-- Seleccione --') {
    const select = document.getElementById(elementId);
    if (!select) return;
    const safeItems = Array.isArray(items) ? items : [];
    select.innerHTML = `<option value="">${placeholder}</option>`;
    safeItems.forEach((item) => {
        const value = item?.[valueField];
        const label = item?.[labelField];
        if (value === undefined || label === undefined) return;
        select.innerHTML += `<option value="${escapeOptionText(value)}">${escapeOptionText(label)}</option>`;
    });
}

function getSelectedPersonaConfig() {
    const tipoPersonaId = document.getElementById('tipoPersona')?.value || '';
    return personaTypes.find((p) => String(p.id_tipo_persona) === String(tipoPersonaId)) || null;
}

function setRequiredFieldById(fieldId, required) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    field.required = !!required;
}

function clearFieldValueById(fieldId) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    if (field.tagName === 'SELECT') {
        field.value = '';
    } else if (field.type === 'checkbox' || field.type === 'radio') {
        field.checked = false;
    } else {
        field.value = '';
    }
}

function populateKycCatalogs() {
    populateSelectFromCatalog('kyc_id_actividad', catalogs.actividades, 'id_actividad', 'nombre', '-- Seleccione actividad --');
    populateSelectFromCatalog('kyc_id_ocupacion', catalogs.ocupaciones, 'id_ocupacion', 'nombre', '-- Seleccione ocupación --');
    populateSelectFromCatalog('kyc_id_profesion', catalogs.profesiones, 'id_profesion', 'nombre', '-- Seleccione profesión --');
    populateSelectFromCatalog('kyc_id_origen_recursos', catalogs.origenes_recursos, 'id_origen_recursos', 'nombre', '-- Seleccione origen --');
}

function togglePepExtraFields(forceReset = false) {
    const selector = document.getElementById('kyc_tiene_familiar_pep');
    const wrapper = document.getElementById('kyc-pep-extra');
    if (!selector || !wrapper) return;

    const isPep = selector.value === '1';
    wrapper.style.display = isPep ? 'block' : 'none';

    setRequiredFieldById('kyc_parentesco_familiar_pep', isPep);
    setRequiredFieldById('kyc_nombre_familiar_pep', isPep);
    setRequiredFieldById('kyc_puesto_familiar_pep', isPep);
    setRequiredFieldById('kyc_fecha_ingreso_pep', isPep);

    if (!isPep || forceReset) {
        clearFieldValueById('kyc_parentesco_familiar_pep');
        clearFieldValueById('kyc_nombre_familiar_pep');
        clearFieldValueById('kyc_puesto_familiar_pep');
        clearFieldValueById('kyc_fecha_ingreso_pep');
    }
}

function toggleKycSectionsByPersona(persona = null) {
    const cfg = persona || getSelectedPersonaConfig();
    const isFisica = Number(cfg?.es_fisica || 0) > 0;
    const fisicaOnly = document.getElementById('kyc-fisica-only');

    if (fisicaOnly) {
        fisicaOnly.style.display = isFisica ? 'block' : 'none';
    }

    setRequiredFieldById('kyc_id_actividad', !!cfg);
    setRequiredFieldById('kyc_antiguedad_anios', !!cfg);
    setRequiredFieldById('kyc_id_origen_recursos', !!cfg);
    setRequiredFieldById('kyc_tiene_familiar_pep', isFisica);
    setRequiredFieldById('kyc_empleo_actual', isFisica);
    setRequiredFieldById('kyc_id_ocupacion', isFisica);
    setRequiredFieldById('kyc_nivel_estudios', isFisica);

    if (!isFisica) {
        clearFieldValueById('kyc_empleo_actual');
        clearFieldValueById('kyc_id_ocupacion');
        clearFieldValueById('kyc_nivel_estudios');
        clearFieldValueById('kyc_tiene_familiar_pep');
        togglePepExtraFields(true);
    } else {
        togglePepExtraFields(false);
    }
}

function buildAddressTypeOptionsHtml() {
    return ADDRESS_TYPE_OPTIONS.map((opt) => `<option value="${opt.id}">${opt.label}</option>`).join('');
}

function normalizeAddressValue(value) {
    return (value || '')
        .toString()
        .trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
}

function buildSepomexStateCacheKey(stateName) {
    return normalizeAddressValue(stateName);
}

function buildSepomexMunicipalityCacheKey(stateName, municipalityName) {
    return `${normalizeAddressValue(stateName)}|${normalizeAddressValue(municipalityName)}`;
}

function escapeOptionText(value) {
    return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}

function getAvailableStateNames() {
    if (Array.isArray(sepomexCache.states) && sepomexCache.states.length > 0) {
        return sepomexCache.states;
    }
    return MEXICO_STATES_FALLBACK;
}

function buildStateOptionsHtml() {
    return getAvailableStateNames().map((state) => `<option value="${escapeOptionText(state)}">${escapeOptionText(state)}</option>`).join('');
}

async function fetchSepomex(mode, params = {}) {
    const query = new URLSearchParams({ mode, ...params });
    const response = await fetch(`api/get_sepomex_catalog.php?${query.toString()}`);
    const payload = await response.json().catch(() => null);
    if (!response.ok || !payload || payload.status !== 'success') {
        throw new Error(payload?.message || 'No fue posible consultar el catálogo SEPOMEX.');
    }
    return payload.data;
}

async function ensureSepomexStatesLoaded() {
    if (sepomexCache.statesReady) {
        return sepomexCache.states;
    }
    try {
        const states = await fetchSepomex('states');
        sepomexCache.states = Array.isArray(states) && states.length > 0 ? states : [...MEXICO_STATES_FALLBACK];
    } catch (error) {
        console.warn('SEPOMEX no disponible, usando estados de respaldo.', error);
        sepomexCache.states = [...MEXICO_STATES_FALLBACK];
    }
    sepomexCache.statesReady = true;
    return sepomexCache.states;
}

function setStateOptionsForRow(estadoSelect) {
    if (!estadoSelect) return;
    const currentValue = estadoSelect.value || '';
    estadoSelect.innerHTML = `<option value="">-- Seleccione --</option>${buildStateOptionsHtml()}`;
    if (!currentValue) return;
    selectStateOptionByName(estadoSelect, currentValue);
}

async function getMunicipalitiesByState(stateName) {
    const key = buildSepomexStateCacheKey(stateName);
    if (sepomexCache.municipalitiesByState.has(key)) {
        return sepomexCache.municipalitiesByState.get(key);
    }

    let municipios = [];
    try {
        municipios = await fetchSepomex('municipalities', { state: stateName });
    } catch (error) {
        console.warn('No fue posible consultar municipios SEPOMEX, usando respaldo.', error);
        municipios = MEXICO_MUNICIPALITIES_FALLBACK[stateName] || [];
    }

    sepomexCache.municipalitiesByState.set(key, municipios);
    return municipios;
}

async function getPostalCodesByStateMunicipality(stateName, municipalityName, prefix = '') {
    const key = `${buildSepomexMunicipalityCacheKey(stateName, municipalityName)}|${(prefix || '').trim()}`;
    if (sepomexCache.postalCodesByStateMunicipality.has(key)) {
        return sepomexCache.postalCodesByStateMunicipality.get(key);
    }

    let postalCodes = [];
    try {
        postalCodes = await fetchSepomex('postal_codes', {
            state: stateName,
            municipality: municipalityName,
            q: (prefix || '').trim()
        });
    } catch (error) {
        console.warn('No fue posible consultar C.P. SEPOMEX.', error);
    }

    sepomexCache.postalCodesByStateMunicipality.set(key, postalCodes);
    return postalCodes;
}

async function lookupSepomexByPostalCode(postalCode, municipalityHint = '') {
    const cp = String(postalCode || '').trim();
    if (!/^\d{5}$/.test(cp)) {
        return null;
    }
    const cacheKey = municipalityHint ? `${cp}|${normalizeAddressValue(municipalityHint)}` : cp;
    if (sepomexCache.cpLookup.has(cacheKey)) {
        return sepomexCache.cpLookup.get(cacheKey);
    }
    try {
        const result = await fetchSepomex('postal_code_lookup', {
            postal_code: cp,
            municipality: municipalityHint || ''
        });
        sepomexCache.cpLookup.set(cacheKey, result);
        return result;
    } catch (error) {
        console.warn('No fue posible resolver C.P. con SEPOMEX.', error);
        return null;
    }
}

function setDataListOptions(dataListEl, values) {
    if (!dataListEl) return;
    const uniqueValues = Array.from(new Set((values || []).map((v) => String(v || '').trim()).filter(Boolean)));
    dataListEl.innerHTML = uniqueValues.map((value) => `<option value="${escapeOptionText(value)}"></option>`).join('');
}

function selectStateOptionByName(estadoSelect, stateName) {
    if (!estadoSelect || !stateName) return '';
    const target = normalizeAddressValue(stateName);
    const options = Array.from(estadoSelect.options);
    let directMatch = options.find((opt) => normalizeAddressValue(opt.value) === target);
    if (!directMatch) {
        directMatch = options.find((opt) => normalizeAddressValue(opt.textContent) === target);
    }
    if (!directMatch) {
        directMatch = options.find((opt) => {
            const valueNorm = normalizeAddressValue(opt.value);
            return valueNorm.includes(target) || target.includes(valueNorm);
        });
    }
    if (directMatch) {
        estadoSelect.value = directMatch.value;
        return directMatch.value;
    }
    return '';
}

async function resolvePostalCodeForRow(row, force = false) {
    if (!row) return;
    const estadoSelect = row.querySelector('select[name="dir_estado[]"]');
    const municipioInput = row.querySelector('input[name="dir_municipio[]"]');
    const cpInput = row.querySelector('input[name="dir_cp[]"]');
    const coloniaInput = row.querySelector('input[name="dir_colonia[]"]');
    const municipioDataList = row.querySelector('datalist[data-role="municipios"]');
    const cpDataList = row.querySelector('datalist[data-role="cp"]');
    const coloniaDataList = row.querySelector('datalist[data-role="colonias"]');
    if (!estadoSelect || !municipioInput || !cpInput || !municipioDataList || !cpDataList || !coloniaInput || !coloniaDataList) return;

    const cp = String(cpInput.value || '').trim();
    if (!/^\d{5}$/.test(cp)) {
        setDataListOptions(coloniaDataList, []);
        return;
    }
    const lastCp = row.dataset.lastCpLookup || '';
    if (!force && lastCp === cp) {
        return;
    }

    const lookup = await lookupSepomexByPostalCode(cp, municipioInput.value);
    row.dataset.lastCpLookup = cp;
    if (!lookup) return;

    if (lookup.state) {
        selectStateOptionByName(estadoSelect, lookup.state);
    }
    if (lookup.municipality) {
        municipioInput.value = lookup.municipality;
    }
    if (Array.isArray(lookup.colonias)) {
        setDataListOptions(coloniaDataList, lookup.colonias);
        if (!coloniaInput.value.trim() && lookup.colonias.length === 1) {
            coloniaInput.value = lookup.colonias[0];
        }
    }
    if (Array.isArray(lookup.colonias_by_municipality) && lookup.colonias_by_municipality.length > 0) {
        setDataListOptions(coloniaDataList, lookup.colonias_by_municipality);
    }
    await updateAddressCatalogForRow(row, { fromCpLookup: true });
}

async function updateAddressCatalogForRow(row, options = {}) {
    if (!row) return;
    const estadoSelect = row.querySelector('select[name="dir_estado[]"]');
    const municipioInput = row.querySelector('input[name="dir_municipio[]"]');
    const cpInput = row.querySelector('input[name="dir_cp[]"]');
    const municipioDataList = row.querySelector('datalist[data-role="municipios"]');
    const cpDataList = row.querySelector('datalist[data-role="cp"]');
    const coloniaDataList = row.querySelector('datalist[data-role="colonias"]');
    if (!estadoSelect || !municipioInput || !cpInput || !municipioDataList || !cpDataList || !coloniaDataList) return;

    await ensureSepomexStatesLoaded();
    setStateOptionsForRow(estadoSelect);

    const estado = estadoSelect.value || '';
    if (!estado) {
        setDataListOptions(municipioDataList, []);
        setDataListOptions(cpDataList, []);
        setDataListOptions(coloniaDataList, []);
        return;
    }

    const municipios = await getMunicipalitiesByState(estado);
    setDataListOptions(municipioDataList, municipios);

    const municipio = String(municipioInput.value || '').trim();
    if (!municipio) {
        if (!options.fromCpLookup) {
            setDataListOptions(cpDataList, []);
            setDataListOptions(coloniaDataList, []);
        }
        return;
    }

    const cpPrefix = String(cpInput.value || '').trim();
    const postalCodes = await getPostalCodesByStateMunicipality(estado, municipio, /^\d{1,5}$/.test(cpPrefix) ? cpPrefix : '');
    setDataListOptions(cpDataList, postalCodes);

    if (!options.fromCpLookup && /^\d{5}$/.test(cpPrefix)) {
        const lookup = await lookupSepomexByPostalCode(cpPrefix, municipio);
        if (lookup && Array.isArray(lookup.colonias)) {
            setDataListOptions(coloniaDataList, lookup.colonias);
        } else {
            setDataListOptions(coloniaDataList, []);
        }
    }
}

function captureLocationForRow(buttonEl) {
    const row = buttonEl?.closest('.dynamic-list-item');
    if (!row) return;
    const latEl = row.querySelector('input[name="dir_latitud[]"]');
    const lngEl = row.querySelector('input[name="dir_longitud[]"]');
    const statusEl = row.querySelector('.geo-status');
    if (!latEl || !lngEl || !statusEl) return;

    if (!navigator.geolocation) {
        statusEl.textContent = 'Geolocalización no soportada por este navegador.';
        return;
    }

    statusEl.textContent = 'Obteniendo ubicación...';
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            latEl.value = String(position.coords.latitude || '');
            lngEl.value = String(position.coords.longitude || '');
            const lat = Number(latEl.value);
            const lng = Number(lngEl.value);

            statusEl.textContent = `Ubicación capturada (${lat.toFixed(5)}, ${lng.toFixed(5)}). Buscando dirección...`;

            const estadoSelect = row.querySelector('select[name="dir_estado[]"]');
            const municipioInput = row.querySelector('input[name="dir_municipio[]"]');
            const cpInput = row.querySelector('input[name="dir_cp[]"]');
            const coloniaInput = row.querySelector('input[name="dir_colonia[]"]');
            const calleInput = row.querySelector('input[name="dir_calle[]"]');

            try {
                const response = await fetch(`api/reverse_geocode.php?lat=${encodeURIComponent(latEl.value)}&lng=${encodeURIComponent(lngEl.value)}`);
                const payload = await response.json().catch(() => null);
                if (!response.ok || !payload || payload.status !== 'success' || !payload.data) {
                    throw new Error(payload?.message || 'No fue posible resolver la dirección.');
                }

                const address = payload.data;
                await ensureSepomexStatesLoaded();

                if (estadoSelect && address.state) {
                    setStateOptionsForRow(estadoSelect);
                    selectStateOptionByName(estadoSelect, address.state);
                }
                if (municipioInput && address.municipality) {
                    municipioInput.value = address.municipality;
                }
                if (cpInput && address.postal_code) {
                    cpInput.value = String(address.postal_code).replace(/\D/g, '').slice(0, 5);
                }
                if (coloniaInput && address.colony && !coloniaInput.value.trim()) {
                    coloniaInput.value = address.colony;
                }
                if (calleInput && address.street && !calleInput.value.trim()) {
                    calleInput.value = address.street;
                }

                await updateAddressCatalogForRow(row);
                if (cpInput && /^\d{5}$/.test(cpInput.value.trim())) {
                    await resolvePostalCodeForRow(row, true);
                }

                statusEl.textContent = `Ubicación y dirección capturadas (${lat.toFixed(5)}, ${lng.toFixed(5)}).`;
            } catch (error) {
                statusEl.textContent = `Ubicación capturada (${lat.toFixed(5)}, ${lng.toFixed(5)}), pero no se pudo autocompletar la dirección.`;
                console.warn('reverse_geocode error', error);
            }
        },
        (error) => {
            statusEl.textContent = 'No fue posible obtener la ubicación: ' + (error.message || 'error desconocido');
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
}

function bindAddressRowEvents(row) {
    if (!row || row.dataset.addressBound === '1') return;
    row.dataset.addressBound = '1';

    const estadoSelect = row.querySelector('select[name="dir_estado[]"]');
    const municipioInput = row.querySelector('input[name="dir_municipio[]"]');
    const cpInput = row.querySelector('input[name="dir_cp[]"]');

    if (estadoSelect) {
        estadoSelect.addEventListener('change', async () => {
            row.dataset.lastCpLookup = '';
            await updateAddressCatalogForRow(row);
        });
    }
    if (municipioInput) {
        const updateFn = async () => {
            row.dataset.lastCpLookup = '';
            await updateAddressCatalogForRow(row);
        };
        municipioInput.addEventListener('blur', updateFn);
        municipioInput.addEventListener('change', updateFn);
    }
    if (cpInput) {
        cpInput.addEventListener('input', async () => {
            cpInput.value = cpInput.value.replace(/\D/g, '').slice(0, 5);
            const cp = cpInput.value.trim();
            if (cp.length === 5) {
                await resolvePostalCodeForRow(row);
            }
        });
        cpInput.addEventListener('blur', async () => {
            if (/^\d{5}$/.test(cpInput.value.trim())) {
                await resolvePostalCodeForRow(row, true);
            }
        });
    }
}

function addDynamicItem(listId, name, catalogData, catValue, catLabel) {
    const list = document.getElementById(listId);
    if (!list) return;
    
    const item = document.createElement('div');
    item.className = 'dynamic-list-item';
    let html = '';
    
    if (listId === 'nacionalidades-list') {
        const nacionalidadOptions = catalogs.paises.map((p) => {
            const nombre = (p.nombre || '').toLowerCase();
            const selected = nombre.includes('mexico') ? ' selected' : '';
            return `<option value="${p.id_pais}"${selected}>${p.nombre}</option>`;
        }).join('');
        html = `
            <div class="col-md-6">
                <label class="form-label small">Nacionalidad*</label>
                <select class="form-select" name="nacionalidad_id[]" required>
                    ${nacionalidadOptions}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label small">Documento soporte (opcional)</label>
                <input type="file" class="form-control" name="nac_doc_file[]" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </div>
        `;
    } else if (listId === 'identificaciones-list') {
        const tiposOptions = catalogs.tipos_identificacion.map(t => `<option value="${t.id_tipo_identificacion}">${t.nombre}</option>`).join('');
        html = `
            <div class="col-md-4">
                <label class="form-label small">Tipo*</label>
                <select class="form-select ident-tipo-select" name="ident_tipo[]" onchange="toggleExtraerIne(this)" required>
                    ${tiposOptions}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label small">Número*</label>
                <input type="text" class="form-control" name="ident_numero[]" placeholder="Número" required>
            </div>
            <div class="col-md-4">
                <label class="form-label small">Vencimiento</label>
                <input type="date" class="form-control" name="ident_vencimiento[]" placeholder="Vencimiento">
            </div>
            <div class="col-md-6">
                <label class="form-label small">Documento soporte (opcional)</label>
                <input type="file" class="form-control" name="ident_doc_file[]" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </div>
            <div class="extraer-ine-block col-12 mt-2" style="display:none;">
                <input type="file" class="d-none" accept=".pdf,.jpg,.jpeg,.png,.gif,.webp" onchange="extraerDatosIne(this)">
                <button type="button" class="btn btn-sm btn-outline-info" onclick="this.previousElementSibling.click()">
                    <i class="fa-solid fa-file-import me-1"></i>Validar INE / Pasaporte (extraer y corroborar)
                </button>
            </div>
        `;
    } else if (listId === 'direcciones-list') {
        const rowId = dynamicRowCounter++;
        const municipioListId = `dir_municipios_${rowId}`;
        const cpListId = `dir_cp_${rowId}`;
        const coloniaListId = `dir_colonias_${rowId}`;
        html = `
            <div class="col-md-3">
                <label class="form-label small">Tipo dirección*</label>
                <select class="form-select dir-tipo-select" name="dir_tipo[]" required>
                    <option value="">-- Seleccione --</option>
                    ${buildAddressTypeOptionsHtml()}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Estado (México)*</label>
                <select class="form-select dir-estado-select" name="dir_estado[]" required>
                    <option value="">-- Seleccione --</option>
                    ${buildStateOptionsHtml()}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Municipio / Alcaldía*</label>
                <input type="text" class="form-control dir-municipio-input" name="dir_municipio[]" list="${municipioListId}" required>
                <datalist id="${municipioListId}" data-role="municipios"></datalist>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Código Postal*</label>
                <input type="text" class="form-control dir-cp-input" name="dir_cp[]" list="${cpListId}" inputmode="numeric" pattern="\\d{5}" maxlength="5" placeholder="5 dígitos" required>
                <datalist id="${cpListId}" data-role="cp"></datalist>
            </div>
            <div class="col-md-4">
                <label class="form-label small">Calle y número*</label>
                <input type="text" class="form-control dir-calle-input" name="dir_calle[]" placeholder="Calle y número" required>
            </div>
            <div class="col-md-4">
                <label class="form-label small">Colonia*</label>
                <input type="text" class="form-control dir-colonia-input" name="dir_colonia[]" list="${coloniaListId}" placeholder="Colonia" required>
                <datalist id="${coloniaListId}" data-role="colonias"></datalist>
            </div>
            <div class="col-md-4">
                <label class="form-label small">Documento soporte (opcional)</label>
                <input type="file" class="form-control" name="dir_doc_file[]" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </div>
            <div class="col-md-12 d-flex align-items-center gap-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="captureLocationForRow(this)">
                    <i class="fa-solid fa-location-crosshairs me-1"></i>Usar geolocalización
                </button>
                <span class="small text-muted geo-status">Sin ubicación capturada.</span>
                <input type="hidden" name="dir_latitud[]">
                <input type="hidden" name="dir_longitud[]">
                <input type="hidden" name="dir_pais[]" value="157">
            </div>
        `;
    } else if (listId === 'contactos-list') {
        const options = catalogs.tipos_contacto.map(t => `<option value="${t.id_tipo_contacto}">${t.nombre}</option>`).join('');
        html = `
            <div class="col-md-4">
                <label class="form-label small">Tipo de contacto*</label>
                <select class="form-select" name="contacto_id_tipo[]" required>${options}</select>
            </div>
            <div class="col-md-8">
                <label class="form-label small">Dato de contacto*</label>
                <input type="text" class="form-control" name="contacto_valor[]" placeholder="Dato de Contacto" required>
            </div>
        `;
    }
    
    item.innerHTML = `<div class="row w-100 g-2">${html}</div><button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button>`;
    list.appendChild(item);
    if (listId === 'identificaciones-list') {
        const sel = item.querySelector('.ident-tipo-select');
        if (sel) {
            toggleExtraerIne(sel);
        }
    }
    if (listId === 'direcciones-list') {
        bindAddressRowEvents(item);
        updateAddressCatalogForRow(item);
    }
}

function addApoderadoItem() {
    const list = document.getElementById('apoderados-list');
    if (!list) return;
    
    const item = document.createElement('div');
    const index = apoderadoCounter++;
    item.className = 'border p-3 rounded mb-3 bg-light';
    item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Nuevo Apoderado</h6>
            <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.border').remove()"><i class="fa-solid fa-trash"></i></button>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label small">Tipo de Apoderado*</label>
                <select class="form-select" name="apoderado[${index}][id_tipo_persona]" onchange="toggleApoderadoType(this, ${index})" required>
                    <option value="">-- Seleccione --</option>
                    ${catalogs.tipos_persona.filter(p => p.es_fisica > 0 || p.es_moral > 0).map(p => `<option value="${p.id_tipo_persona}">${p.nombre}</option>`).join('')}
                </select>
            </div>
        </div>
        <div id="apoderado-fisica-${index}" class="apoderado-specific" style="display:none;">
            <div class="row">
                <div class="col-md-4 mb-3"><label class="small">Nombre*</label><input type="text" class="form-control" name="apoderado[${index}][fisica_nombre]"></div>
                <div class="col-md-4 mb-3"><label class="small">Apellido Paterno*</label><input type="text" class="form-control" name="apoderado[${index}][fisica_ap_paterno]"></div>
                <div class="col-md-4 mb-3"><label class="small">Apellido Materno</label><input type="text" class="form-control" name="apoderado[${index}][fisica_ap_materno]"></div>
                <div class="col-md-6 mb-3"><label class="small">RFC*</label><input type="text" class="form-control" name="apoderado[${index}][fisica_tax_id]"></div>
                <div class="col-md-6 mb-3"><label class="small">CURP</label><input type="text" class="form-control" name="apoderado[${index}][fisica_curp]"></div>
            </div>
        </div>
        <div id="apoderado-moral-${index}" class="apoderado-specific" style="display:none;">
            <div class="row">
                <div class="col-md-6 mb-3"><label class="small">Razón Social*</label><input type="text" class="form-control" name="apoderado[${index}][moral_razon_social]"></div>
                <div class="col-md-6 mb-3"><label class="small">RFC*</label><input type="text" class="form-control" name="apoderado[${index}][moral_tax_id]"></div>
            </div>
        </div>
        <hr>
        <div class="mb-2"><label class="form-label small fw-bold">Contactos del Apoderado</label></div>
        <div id="apoderado-contactos-list-${index}"></div>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addApoderadoContactoItem(${index})"><i class="fa-solid fa-plus"></i> Agregar Contacto (Apoderado)</button>
    `;
    list.appendChild(item);
}

function addApoderadoContactoItem(apoderadoIndex) {
    const list = document.getElementById(`apoderado-contactos-list-${apoderadoIndex}`);
    if (!list) return;
    
    const item = document.createElement('div');
    item.className = 'dynamic-list-item';
    const options = catalogs.tipos_contacto.map(t => `<option value="${t.id_tipo_contacto}">${t.nombre}</option>`).join('');
    item.innerHTML = `<select class="form-select" name="apoderado[${apoderadoIndex}][contactos][tipo][]">${options}</select>
            <input type="text" class="form-control" name="apoderado[${apoderadoIndex}][contactos][valor][]" placeholder="Dato de Contacto">
            <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button>`;
    list.appendChild(item);
}

function toggleApoderadoType(selectElement, index) {
    const selectedId = selectElement.value;
    const persona = catalogs.tipos_persona.find(p => p.id_tipo_persona == selectedId);
    
    const fisicaEl = document.getElementById(`apoderado-fisica-${index}`);
    const moralEl = document.getElementById(`apoderado-moral-${index}`);
    
    if (fisicaEl) fisicaEl.style.display = 'none';
    if (moralEl) moralEl.style.display = 'none';
    
    if (persona) {
        if (persona.es_fisica > 0 && fisicaEl) fisicaEl.style.display = 'block';
        if (persona.es_moral > 0 && moralEl) moralEl.style.display = 'block';
    }
}

function addDocumentoItem() {
    const list = document.getElementById('documentos-list');
    if (!list) return;
    
    const item = document.createElement('div');
    item.className = 'dynamic-list-item row g-2';
    item.innerHTML = `
        <div class="col-md-4"><input type="text" class="form-control" name="doc_tipo[]" placeholder="Tipo de Documento"></div>
        <div class="col-md-5"><input type="file" class="form-control" name="doc_file[]"></div>
        <div class="col-md-2"><input type="date" class="form-control" name="doc_vencimiento[]"></div>
        <div class="col-md-1"><button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.dynamic-list-item').remove()"><i class="fa-solid fa-trash"></i></button></div>
    `;
    list.appendChild(item);
}

// --- 4. INITIALIZATION ---
document.addEventListener('DOMContentLoaded', function() {
    setupBidirectionalSync('general_fisica_nombre', 'fisica_nombre');
    setupBidirectionalSync('general_fisica_ap_paterno', 'fisica_ap_paterno');
    setupBidirectionalSync('general_fisica_ap_materno', 'fisica_ap_materno');
    setupBidirectionalSync('general_moral_razon_social', 'moral_razon_social');
    setupBidirectionalSync('general_fide_numero', 'fide_numero');

    const maxBirthDate = new Date();
    maxBirthDate.setFullYear(maxBirthDate.getFullYear() - 18);
    const fechaNacimientoInput = document.getElementById('fisica_fecha_nacimiento');
    if (fechaNacimientoInput) {
        fechaNacimientoInput.max = formatDateForInput(maxBirthDate);
    }
    const fechaConstitucionInput = document.getElementById('moral_fecha_constitucion');
    if (fechaConstitucionInput) {
        fechaConstitucionInput.max = formatDateForInput(new Date());
    }

    ['fisica_tax_id', 'fisica_curp', 'moral_tax_id'].forEach((id) => {
        const field = document.getElementById(id);
        if (!field) return;
        field.addEventListener('input', () => {
            field.value = (field.value || '').toUpperCase().replace(/\s+/g, '');
            field.setCustomValidity('');
        });
    });

    const handleIdentityChange = () => {
        const payload = getPldSearchPayload(true);
        const currentSignature = payload.ok ? getPldSearchSignature(payload.data) : '';
        if (currentSignature !== lastPldSignature) {
            resetPldValidationState();
        }
    };
    [
        'fisica_nombre',
        'fisica_ap_paterno',
        'fisica_ap_materno',
        'moral_razon_social',
        'general_fisica_nombre',
        'general_fisica_ap_paterno',
        'general_fisica_ap_materno',
        'general_moral_razon_social'
    ].forEach((id) => {
        const field = document.getElementById(id);
        if (field) field.addEventListener('input', handleIdentityChange);
    });

    const generalMoralNombreCom = document.getElementById('general_moral_nombre_comercial');
    if (generalMoralNombreCom) {
        generalMoralNombreCom.addEventListener('input', () => {
            const hidden = document.getElementById('moral_nombre_comercial');
            if (hidden) hidden.value = generalMoralNombreCom.value || '';
        });
        const hidden = document.getElementById('moral_nombre_comercial');
        if (hidden) hidden.value = generalMoralNombreCom.value || '';
    }

    const noContratoInput = document.getElementById('noContratoInput');
    const autoFlag = document.getElementById('autoGeneratedContract');
    if (noContratoInput) {
        noContratoInput.addEventListener('input', () => {
            if (autoFlag && autoFlag.value === '1') {
                autoFlag.value = '0';
            }
            isAutoGeneratedContract = false;
            noContratoInput.setCustomValidity('');
            setContractValidationMessage('', 'muted');
        });
        noContratoInput.addEventListener('blur', () => {
            validateContractField(false);
        });
    }

    const btnGenerateContract = document.getElementById('btnGenerateContract');
    if (btnGenerateContract) {
        btnGenerateContract.addEventListener('click', generateContractNumber);
    }

    // Load catalogs
    fetch('api/get_catalogos.php')
        .then(r => {
            if (!r.ok) {
                throw new Error('Error al cargar catálogos: ' + r.status);
            }
            return r.json();
        })
        .then(json => {
            if (json.status === 'success') {
                catalogs = json.data;
                personaTypes = catalogs.tipos_persona;
                populateSelect('tipoPersona', personaTypes, 'id_tipo_persona', 'nombre');
                populateKycCatalogs();
                toggleGeneralPersonaFields(null);
                toggleKycSectionsByPersona(null);
                ensureSepomexStatesLoaded().catch((error) => {
                    console.warn('No fue posible precargar SEPOMEX.', error);
                });
            } else {
                console.error('Error al cargar catálogos:', json.message);
            }
        })
        .catch(err => {
            console.error('Error de conexión al cargar catálogos:', err);
        });

    // Tipo Persona Change Handler
    const tipoPersonaSelect = document.getElementById('tipoPersona');
    if (tipoPersonaSelect) {
        tipoPersonaSelect.addEventListener('change', function(e) {
            const selectedId = e.target.value;
            const persona = personaTypes.find(p => p.id_tipo_persona == selectedId);
            
            document.querySelectorAll('.persona-specific').forEach(el => el.style.display = 'none');
            resetPldValidationState();
            
            if (persona) {
                toggleGeneralPersonaFields(persona);
                toggleKycSectionsByPersona(persona);
                if (persona.es_fisica > 0) {
                    const fisicaEl = document.getElementById('persona-fisica');
                    if (fisicaEl) fisicaEl.style.display = 'block';
                }
                if (persona.es_moral > 0) {
                    const moralEl = document.getElementById('persona-moral');
                    const apoderadosEl = document.getElementById('apoderados-section');
                    if (moralEl) moralEl.style.display = 'block';
                    if (apoderadosEl) apoderadosEl.style.display = 'block';
                } else {
                    const apoderadosEl = document.getElementById('apoderados-section');
                    if (apoderadosEl) apoderadosEl.style.display = 'none';
                }
                if (persona.es_fideicomiso > 0) {
                    const fideicomisoEl = document.getElementById('persona-fideicomiso');
                    const apoderadosEl = document.getElementById('apoderados-section');
                    if (fideicomisoEl) fideicomisoEl.style.display = 'block';
                    if (apoderadosEl) apoderadosEl.style.display = 'block';
                } else if (persona.es_moral == 0) {
                    const apoderadosEl = document.getElementById('apoderados-section');
                    if (apoderadosEl) apoderadosEl.style.display = 'none';
                }
            } else {
                toggleGeneralPersonaFields(null);
                toggleKycSectionsByPersona(null);
                const apoderadosEl = document.getElementById('apoderados-section');
                if (apoderadosEl) apoderadosEl.style.display = 'none';
            }
        });
    }

    const kycPepSelect = document.getElementById('kyc_tiene_familiar_pep');
    if (kycPepSelect) {
        kycPepSelect.addEventListener('change', () => togglePepExtraFields(false));
    }
    
    // Status Change Handler
    const idStatusSelect = document.getElementById('id_status');
    if (idStatusSelect) {
        idStatusSelect.addEventListener('change', function(e) {
            const status = e.target.value;
            const bajaContainer = document.getElementById('fechaBajaContainer');
            if (bajaContainer) {
                const bajaInput = bajaContainer.querySelector('input');
                if (status == '3') {
                    bajaContainer.style.display = 'block';
                    if (bajaInput) bajaInput.required = true;
                } else {
                    bajaContainer.style.display = 'none';
                    if (bajaInput) {
                        bajaInput.required = false;
                        bajaInput.value = null;
                    }
                }
            }
        });
    }

    // Event Listeners for Dynamic Items
    const addNacionalidad = document.getElementById('addNacionalidad');
    if (addNacionalidad) {
        addNacionalidad.addEventListener('click', () => addDynamicItem('nacionalidades-list', 'nacionalidad[]', catalogs.paises, 'id_pais', 'nombre'));
    }
    
    const addIdentificacion = document.getElementById('addIdentificacion');
    if (addIdentificacion) {
        addIdentificacion.addEventListener('click', () => addDynamicItem('identificaciones-list', 'identificacion[]', catalogs.tipos_identificacion, 'id_tipo_identificacion', 'nombre'));
    }
    
    const addDireccion = document.getElementById('addDireccion');
    if (addDireccion) {
        addDireccion.addEventListener('click', () => addDynamicItem('direcciones-list', 'direccion[]'));
    }
    
    const addContacto = document.getElementById('addContacto');
    if (addContacto) {
        addContacto.addEventListener('click', () => addDynamicItem('contactos-list', 'contacto[]'));
    }
    
    const addDocumento = document.getElementById('addDocumento');
    if (addDocumento) {
        addDocumento.addEventListener('click', () => addDocumentoItem());
    }
    
    const addApoderado = document.getElementById('addApoderado');
    if (addApoderado) {
        addApoderado.addEventListener('click', () => addApoderadoItem());
    }

    /**
     * Muestra errores de validación PLD en un SweetAlert estructurado
     * @param {Object} data - Respuesta del servidor { status, code, message, razon, faltantes, detalles, todos_errores }
     */
    function mostrarErrorValidacion(data) {
        const code = data.code || '';
        const titulo = data.message || 'Error de validación';
        let html = '';

        if (data.razon) {
            html += '<p class="text-start mb-2"><strong>Razón:</strong> ' + escapeHtml(data.razon) + '</p>';
        }
        if (Array.isArray(data.faltantes) && data.faltantes.length > 0) {
            html += '<p class="text-start mb-1"><strong>Elementos faltantes:</strong></p>';
            html += '<ul class="text-start mb-0 ps-3">';
            data.faltantes.forEach(f => {
                html += '<li>' + escapeHtml(typeof f === 'string' ? f : (f.descripcion || JSON.stringify(f))) + '</li>';
            });
            html += '</ul>';
        }
        if (Array.isArray(data.detalles) && data.detalles.length > 0) {
            html += '<p class="text-start mb-1 mt-2"><strong>Detalles:</strong></p>';
            html += '<ul class="text-start mb-0 ps-3">';
            data.detalles.forEach(d => {
                const txt = typeof d === 'object' ? (d.razon || d.mensaje || JSON.stringify(d)) : String(d);
                html += '<li>' + escapeHtml(txt) + '</li>';
            });
            html += '</ul>';
        }
        if (Array.isArray(data.todos_errores) && data.todos_errores.length > 0) {
            html += '<p class="text-start mb-1 mt-2"><strong>Validaciones pendientes:</strong></p>';
            html += '<ul class="text-start mb-0 ps-3">';
            data.todos_errores.forEach(e => {
                html += '<li><span class="badge bg-secondary me-1">' + escapeHtml(e.validacion || e.codigo || '') + '</span> ' + escapeHtml(e.mensaje || e.razon || '') + '</li>';
            });
            html += '</ul>';
        }
        if (data.dias_vencido != null && data.dias_vencido !== undefined) {
            html += '<p class="text-start mb-0 mt-2 text-muted small">Días vencido: ' + data.dias_vencido + '</p>';
        }
        if (!html && data.message) {
            html = '<p class="mb-0">' + escapeHtml(data.message) + '</p>';
        }
        if (!html) html = '<p class="mb-0">Error desconocido. Revise que el expediente esté completo.</p>';

        Swal.fire({
            icon: code === 'EXPEDIENTE_VENCIDO' ? 'warning' : 'error',
            title: titulo,
            html: html || undefined,
            confirmButtonText: 'Entendido',
            customClass: { htmlContainer: 'text-start' }
        });
    }

    function escapeHtml(str) {
        if (str == null || str === undefined) return '';
        const s = String(str);
        return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // Form Submit Handler
    const newClientForm = document.getElementById('newClientForm');
    if (newClientForm) {
        newClientForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const isStep4Valid = validateStep4BeforeSubmit();
            if (!isStep4Valid) return;
            
            // Disable submit button to prevent double submission
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn ? submitBtn.innerHTML : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Guardando...';
            }
            
            const formData = new FormData(this);
            
            fetch('api/save_client.php', { 
                method: 'POST', 
                body: formData 
            })
            .then(res => res.text().then(text => ({ ok: res.ok, status: res.status, text })))
            .then(({ ok, status, text }) => {
                let data;
                try {
                    data = JSON.parse(text);
                } catch (parseErr) {
                    console.error('Error parsing JSON:', text);
                    throw new Error(text ? ('Servidor: ' + text.substring(0, 300)) : `HTTP ${status}`);
                }
                
                if (data.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Cliente guardado',
                        text: 'ID: ' + data.id_cliente,
                        confirmButtonText: 'Continuar'
                    }).then(() => { window.location.href = 'clientes.php'; });
                } else {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                    }
                    mostrarErrorValidacion(data);
                }
            })
            .catch(err => {
                console.error('Error al guardar cliente:', err);
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
                Swal.fire({
                    icon: 'error',
                    title: 'Error al guardar cliente',
                    text: err.message || 'Error de conexión'
                });
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            });
        });
    }
});

function resolveExtractionDocumentType(selectEl) {
    if (!selectEl) return '';
    const selectedText = (selectEl.options[selectEl.selectedIndex]?.text || '').toLowerCase();
    if (selectedText.includes('pasaport')) return 'passport';
    if (selectedText.includes('ine') || selectedText.includes('elector')) return 'ine';
    return '';
}

/**
 * Muestra/oculta el botón de extracción según tipo de identificación (INE/Pasaporte)
 */
function toggleExtraerIne(selectEl) {
    const row = selectEl.closest('.dynamic-list-item, .row');
    const block = row ? row.querySelector('.extraer-ine-block') : null;
    if (!block) return;
    const docType = resolveExtractionDocumentType(selectEl);
    const hiddenInput = block.querySelector('input[type="file"]');
    if (hiddenInput) hiddenInput.dataset.documentType = docType;
    block.style.display = docType ? 'block' : 'none';
}

/**
 * Extrae datos de INE mediante Starpath API y llena el formulario
 */
function _esc(s) {
    return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

async function extraerDatosIne(fileInput) {
    const file = fileInput.files[0];
    if (!file) return;

    const row = fileInput.closest('.dynamic-list-item');
    const tipoSelect = row ? row.querySelector('.ident-tipo-select') : null;
    const numInput = row ? row.querySelector('input[name="ident_numero[]"]') : null;

    if (!Swal) {
        alert('Subiendo y extrayendo datos...');
    } else {
        Swal.fire({ title: 'Extrayendo datos...', text: 'Espere un momento', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    }

    const documentType = fileInput.dataset.documentType || resolveExtractionDocumentType(tipoSelect) || 'ine';
    const formData = new FormData();
    formData.append('file', file);
    formData.append('document_type', documentType);

    try {
        const res = await fetch('api/extract_ine_starpath.php', { method: 'POST', body: formData });
        const text = await res.text();
        let data;
        try {
            data = text ? JSON.parse(text) : {};
        } catch (parseErr) {
            console.error('Respuesta no JSON:', text.substring(0, 500));
            const msg = text.includes('<!') ? 'El servidor devolvió una página de error. Revise los logs de PHP.' : ('Respuesta: ' + text.substring(0, 200));
            if (Swal) Swal.fire({ icon: 'error', title: 'Error del servidor', html: '<pre class="text-start small text-break">' + _esc(msg || res.status) + '</pre>' });
            fileInput.value = '';
            return;
        }

        if (data.status === 'success' && data.data) {
            const d = data.data;
            // Persona física (Paso 2): formato INE Starpath
            const nomEl = document.getElementById('fisica_nombre');
            const apEl = document.getElementById('fisica_ap_paterno');
            const amEl = document.getElementById('fisica_ap_materno');
            const currentValues = {
                nombre: nomEl?.value || '',
                paterno: apEl?.value || '',
                materno: amEl?.value || '',
                fecha: document.querySelector('input[name="fisica_fecha_nacimiento"]')?.value || '',
                curp: document.querySelector('input[name="fisica_curp"]')?.value || ''
            };
            if (d.nombres && nomEl) nomEl.value = d.nombres;
            if (d.apellido_paterno && apEl) apEl.value = d.apellido_paterno;
            if (d.apellido_materno && amEl) amEl.value = d.apellido_materno;
            if (d.fecha_nacimiento) {
                const fnEl = document.querySelector('input[name="fisica_fecha_nacimiento"]');
                if (fnEl) fnEl.value = d.fecha_nacimiento;
            }
            const curpEl = document.querySelector('input[name="fisica_curp"]');
            if (d.curp && curpEl) curpEl.value = d.curp;
            // Nacionalidad: buscar en catálogo. INE es documento mexicano → México por defecto si no viene
            const nacVal = (d.nacionalidad || d.pais || d.nacionalidad_titular || d.pais_nacimiento || 'México').toString().trim();
            if (nacVal && catalogs.paises && catalogs.paises.length) {
                const nacNorm = nacVal.toLowerCase().replace(/á/g,'a').replace(/é/g,'e').replace(/í/g,'i').replace(/ó/g,'o').replace(/ú/g,'u');
                const match = catalogs.paises.find(p => {
                    const pNorm = (p.nombre || '').toLowerCase().replace(/á/g,'a').replace(/é/g,'e').replace(/í/g,'i').replace(/ó/g,'o').replace(/ú/g,'u');
                    return pNorm.includes(nacNorm) || nacNorm.includes(pNorm) || (p.codigo && p.codigo.toUpperCase() === nacVal.toUpperCase().slice(0,3));
                });
                if (match) {
                    const nacList = document.getElementById('nacionalidades-list');
                    let nacItem = nacList ? nacList.querySelector('.dynamic-list-item') : null;
                    if (!nacItem && nacList) {
                        addDynamicItem('nacionalidades-list', 'nacionalidad[]', catalogs.paises, 'id_pais', 'nombre');
                        nacItem = nacList.querySelector('.dynamic-list-item:last-child');
                    }
                    const nacSel = nacItem ? nacItem.querySelector('select[name="nacionalidad_id[]"]') : null;
                    if (nacSel) nacSel.value = match.id_pais;
                }
            }
            // Fallback: si viene titular (formato anterior) en lugar de nombres/apellidos
            if (!d.nombres && d.titular) {
                const partes = String(d.titular).trim().split(/\s+/);
                if (partes.length >= 3 && apEl && amEl && nomEl) {
                    apEl.value = partes[0] || '';
                    amEl.value = partes[1] || '';
                    nomEl.value = partes.slice(2).join(' ') || '';
                } else if (nomEl) nomEl.value = d.titular;
            }
            // Identificación INE: número completo (seccion+clave+anios+emision) o clave_elector
            if (numInput) {
                let ineNum = '';
                if (d.seccion && d.clave_elector && d.anio_registro) {
                    ineNum = [d.seccion, d.clave_elector, d.anio_registro, d.anio_emision || d.anio_registro, d.numero_emision_credencial || '0001'].filter(Boolean).join('');
                }
                if (!ineNum) ineNum = d.clave_elector || d.numero_emision_credencial || d.referencia || d.curp || d.numero_ine;
                if (ineNum) numInput.value = ineNum;
            }
            // Vencimiento: vigencia (año) -> último día del año
            if (d.vigencia) {
                const venEl = row ? row.querySelector('input[name="ident_vencimiento[]"]') : null;
                if (venEl) venEl.value = d.vigencia + '-12-31';
            }
            // Dirección: domicilio, localidad, municipio, estado. CP si está en domicilio (5 dígitos)
            const tieneDir = d.domicilio || d.direccion || d.localidad || d.municipio || d.estado;
            if (tieneDir) {
                const dirList = document.getElementById('direcciones-list');
                let dirItem = dirList ? dirList.querySelector('.dynamic-list-item') : null;
                if (!dirItem && dirList) {
                    addDynamicItem('direcciones-list', 'dir', null, null, null);
                    dirItem = dirList.querySelector('.dynamic-list-item:last-child');
                }
                if (dirItem) {
                    const c = dirItem.querySelector('input[name="dir_calle[]"]');
                    const col = dirItem.querySelector('input[name="dir_colonia[]"]');
                    const cpIn = dirItem.querySelector('input[name="dir_cp[]"]');
                    const estadoSel = dirItem.querySelector('select[name="dir_estado[]"]');
                    const municipioIn = dirItem.querySelector('input[name="dir_municipio[]"]');
                    let calle = d.domicilio || d.direccion || d.calle || '';
                    let colonia = d.colonia || '';
                    let cp = d.codigo_postal || d.cp || '';
                    const estado = (d.estado || '').toString().trim();
                    const municipio = (d.municipio || d.localidad || '').toString().trim();
                    if (calle && !colonia) {
                        const colMatch = calle.match(/\bCOL\s+(.+?)(?:\s+\d{5}|\s*$)/i);
                        if (colMatch) colonia = colMatch[1].trim();
                    }
                    if (calle && !cp) {
                        const cpMatch = calle.match(/\b(\d{5})\b/);
                        if (cpMatch) cp = cpMatch[1];
                    }
                    if (c) c.value = calle;
                    if (col) col.value = colonia;
                    if (cpIn) cpIn.value = cp;
                    if (estadoSel && estado) {
                        await ensureSepomexStatesLoaded();
                        setStateOptionsForRow(estadoSel);
                        selectStateOptionByName(estadoSel, estado);
                    }
                    if (municipioIn && municipio) {
                        municipioIn.value = municipio;
                    }
                    await updateAddressCatalogForRow(dirItem);
                    if (cpIn && /^\d{5}$/.test(String(cpIn.value || '').trim())) {
                        await resolvePostalCodeForRow(dirItem, true);
                    }
                }
            }

            const mismatch = [];
            const expectedNombre = (d.nombres || '').trim();
            const expectedPaterno = (d.apellido_paterno || '').trim();
            const expectedMaterno = (d.apellido_materno || '').trim();
            const expectedFecha = (d.fecha_nacimiento || '').trim();
            const expectedCurp = (d.curp || '').trim().toUpperCase();

            if (currentValues.nombre && expectedNombre && currentValues.nombre.trim().toLowerCase() !== expectedNombre.toLowerCase()) mismatch.push('Nombre');
            if (currentValues.paterno && expectedPaterno && currentValues.paterno.trim().toLowerCase() !== expectedPaterno.toLowerCase()) mismatch.push('Apellido paterno');
            if (currentValues.materno && expectedMaterno && currentValues.materno.trim().toLowerCase() !== expectedMaterno.toLowerCase()) mismatch.push('Apellido materno');
            if (currentValues.fecha && expectedFecha && currentValues.fecha !== expectedFecha) mismatch.push('Fecha de nacimiento');
            if (currentValues.curp && expectedCurp && currentValues.curp.trim().toUpperCase() !== expectedCurp) mismatch.push('CURP');

            // Mostrar etiqueta de datos completados por IA
            const badge = document.getElementById('ai-extraction-badge');
            if (badge) { badge.classList.remove('d-none'); badge.classList.add('d-flex', 'align-items-center'); }
            if (Swal) Swal.fire({
                icon: 'success',
                title: 'Datos extraídos',
                html: 'Se llenaron los campos con la información del documento.<br><small class="text-muted"><i class="fa-solid fa-robot me-1"></i>Datos completados por IA</small>' +
                    (mismatch.length ? `<br><span class="text-warning small">Se detectaron diferencias en: ${mismatch.join(', ')}</span>` : '')
            });
        } else {
            let errHtml = '<p class="mb-0">' + (data.message ? _esc(data.message) : 'No se pudieron extraer los datos') + '</p>';
            if (data.response_preview) {
                errHtml += '<pre class="text-start small mt-2 mb-0 p-2 bg-light rounded overflow-auto" style="max-height:150px;">' +
                    _esc(data.response_preview) + '</pre>';
            }
            if (data._debug) {
                if (data._debug.exception) {
                    errHtml += '<pre class="text-start small mt-2 mb-0 p-2 bg-light rounded">' +
                        _esc(data._debug.file) + ':' + _esc(data._debug.line) + '\n' +
                        _esc((data._debug.trace || '').substring(0, 600)) + '</pre>';
                } else {
                    errHtml += '<pre class="text-start small mt-2 mb-0 p-2 bg-light rounded">' +
                        'HTTP: ' + _esc(data._debug.http_code) + '\n' +
                        _esc((data._debug.response_preview || '').substring(0, 400)) + '</pre>';
                }
            }
            if (Swal) Swal.fire({ icon: 'error', title: 'Error extracción', html: errHtml });
        }
    } catch (err) {
        console.error(err);
        if (Swal) Swal.fire({ icon: 'error', title: 'Error', text: err.message || 'Error de conexión' });
    }
    fileInput.value = '';
}

// Make functions available globally for inline handlers
window.validatePerson = validatePerson;
window.confirmPld = confirmPld;
window.nextStep = nextStep;
window.prevStep = prevStep;
window.addApoderadoContactoItem = addApoderadoContactoItem;
window.toggleApoderadoType = toggleApoderadoType;
window.toggleExtraerIne = toggleExtraerIne;
window.extraerDatosIne = extraerDatosIne;
window.captureLocationForRow = captureLocationForRow;
